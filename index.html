<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏ß‡πá‡∏õ/‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" sizes="180x180" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#4CAF50">

<style>
body { font-family:'Segoe UI',sans-serif; margin:0;padding:20px; display:flex;justify-content:center; background:linear-gradient(to bottom right,#f0f4f8,#d9e2ec); color:#000; transition:0.3s;}
body.dark{background:linear-gradient(to bottom right,#1e1e1e,#2c2c2c); color:#fff;}
.container{width:95%; max-width:720px; background:#fff; padding:25px 30px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.12); transition:0.3s;}
body.dark .container{background:#2a2a2a; box-shadow:0 10px 30px rgba(0,0,0,0.5); color:#fff;}
h2{text-align:center; margin-top:0;}
.language-select{text-align:right; margin-bottom:15px;}
details{margin:15px 0; border-radius:12px; padding:12px; background:#f9fafc; box-shadow:0 2px 8px rgba(0,0,0,0.08);}
body.dark details{background:#333; box-shadow:0 2px 8px rgba(0,0,0,0.5); color:#fff;}
details summary{font-weight:600; font-size:16px; cursor:pointer;}
.input-row{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; align-items:center;}
.input-row input, .input-row select{flex:1; padding:10px 12px; border:1px solid #ccd6dd; border-radius:10px; font-size:14px; transition:0.2s; color:#000; background:#fff;}
body.dark .input-row input, body.dark .input-row select{background:#444;color:#fff;border:1px solid #666;}
button{padding:10px 18px; margin-top:12px; cursor:pointer; border:none; border-radius:12px; background:#4CAF50; color:white; font-weight:600; font-size:15px; transition:0.2s;}
#result{margin-top:20px; padding:20px; border-radius:16px; background:#e8f5e9; border:1px solid #a5d6a7; font-weight:500; line-height:1.6;}
body.dark #result{background:#3a3a3a; border:1px solid #666; color:#fff;}
#userPanel {position: fixed; bottom: 15px; right: 15px; max-width: 100px; padding: 10px; background: rgba(76, 175, 80, 0.9); color: #fff; font-size: 14px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 9999; text-align:center;}
#versionPanel {position: fixed; bottom: 15px; left: 15px; padding: 8px 12px; background: rgba(0,0,0,0.6); color: #fff; font-size: 12px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); z-index: 9999; transition:0.3s;}
</style>
</head>
<body>
<div class="container" id="appContent">
  <div class="language-select">
    <select id="langSelect" onchange="switchLang()">
      <option value="th">‡πÑ‡∏ó‡∏¢</option>
      <option value="en">English</option>
    </select>
    <button id="themeBtn" onclick="toggleDarkMode()">üåô</button>
  </div>
  <h2 id="title">üìä ‡πÄ‡∏ß‡πá‡∏õ/‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h2>

  <details open>
    <summary id="labelMaterial">ü•¶ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</summary>
    <div id="materials"></div>
    <button onclick="addMaterial()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</button>
  </details>

  <details>
    <summary id="labelLabor">üíº ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á & ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</summary>
    <div class="input-row">
      <input type="number" id="workers" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô">
      <input type="number" id="wage" placeholder="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô">
    </div>
    <div class="input-row">
      <input type="number" id="water" placeholder="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥">
      <input type="number" id="electricity" placeholder="‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü">
    </div>
  </details>

  <button onclick="calculate()" id="calcBtn">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
  <button onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
  <div id="result"></div>
</div>

<div id="userPanel">üë• = 0</div>
<div id="versionPanel">Beta 1.1.0</div>

<script>
let materialCount=0;
const texts={
  th:{
    title:"üìä ‡πÄ‡∏ß‡πá‡∏õ/‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô", materials:"ü•¶ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö",
    workers:"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô", wage:"‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á/‡∏Ñ‡∏ô", water:"‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥", electricity:"‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü",
    matName:"‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", matQty:"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 2 ‡∏à‡∏≤‡∏ô)", matCost:"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)",
    matProfit:"‡∏Å‡∏≥‡πÑ‡∏£/‡∏ä‡∏¥‡πâ‡∏ô", labor:"üíº ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏£‡∏ß‡∏°", other:"üíß ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ + ‚ö° ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü",
    material:"ü•¶ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", total:"üìä ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°", profitText:"üí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°", sale:"üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°", calc:"‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"
  },
  en:{
    title:"üìä Cost Calculator", materials:"ü•¶ Materials",
    workers:"Workers", wage:"Wage/person", water:"Water", electricity:"Electricity",
    matName:"Material name", matQty:"Qty (e.g., 2 pcs)", matCost:"Cost/unit (‡∏ø)",
    matProfit:"Profit/unit", labor:"üíº Labor cost", other:"üíß Water + ‚ö° Electricity",
    material:"ü•¶ Materials", total:"üìä Total cost", profitText:"üí∞ Total profit", sale:"üíµ Selling price", calc:"Calculate"
  }
};

function addMaterial(name="", qty="", cost="", profit=""){
  materialCount++;
  const lang=document.getElementById("langSelect").value;
  const t=texts[lang];
  const div=document.createElement("div");
  div.className="input-row"; div.id="material-"+materialCount;
  div.innerHTML=`
    <input type="text" placeholder="${t.matName}" value="${name}" style="flex:2">
    <input type="text" placeholder="${t.matQty}" value="${qty}" style="flex:1">
    <input type="number" placeholder="${t.matCost}" value="${cost}" style="flex:1">
    <input type="number" placeholder="${t.matProfit}" value="${profit}" style="flex:1">
    <button onclick="toggleLock(${materialCount})">üîí</button>
    <button onclick="deleteMaterial(${materialCount})">‚ùå</button>
  `;
  document.getElementById("materials").appendChild(div);
}

function toggleLock(id){
  const div=document.getElementById("material-"+id);
  const inputs=div.getElementsByTagName("input");
  const lockBtn=div.getElementsByTagName("button")[0];
  const locked=inputs[0].disabled;
  for(let i=0;i<4;i++){inputs[i].disabled=!locked;}
  lockBtn.textContent=locked?"üîí":"üîì";
}

function deleteMaterial(id){ 
  const div=document.getElementById("material-"+id); 
  if(div) div.remove(); 
  saveData();
}

function calculate(){
  const workers=parseFloat(document.getElementById("workers").value)||0;
  const wage=parseFloat(document.getElementById("wage").value)||0;
  const water=parseFloat(document.getElementById("water").value)||0;
  const electricity=parseFloat(document.getElementById("electricity").value)||0;

  let materialCost=0;
  let profitTotal=0;

  document.querySelectorAll("#materials .input-row").forEach(row=>{
    const qtyStr=row.children[1].value.trim();
    const cost=parseFloat(row.children[2].value)||0;
    const profitEach=parseFloat(row.children[3].value)||0;

    let qty=parseFloat(qtyStr);
    if(isNaN(qty)){
      const m=qtyStr.match(/[\d.]+/);
      qty=m?parseFloat(m[0]):1;
    }

    materialCost += qty*cost;
    profitTotal  += qty*profitEach;
  });

  const laborCost=workers*wage;
  const otherCost=water+electricity;
  const totalCost=laborCost+otherCost+materialCost;
  const sellingPrice=totalCost+profitTotal;

  const lang=document.getElementById("langSelect").value;
  const t=texts[lang];
  document.getElementById("result").innerHTML=`
    ${t.labor}: ${laborCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>
    ${t.other}: ${otherCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>
    ${t.material}: ${materialCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>
    ${t.total}: ${totalCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>
    ${t.profitText}: ${profitTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>
    ${t.sale}: ${sellingPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó
  `;
  saveData();
}

function switchLang(){
  const lang=document.getElementById("langSelect").value;
  const t=texts[lang];
  document.getElementById("title").textContent=t.title;
  document.getElementById("labelMaterial").textContent=t.materials;
  document.getElementById("labelLabor").textContent=t.workers+" & "+t.other;
  document.getElementById("calcBtn").textContent=t.calc;
  document.querySelectorAll("#materials .input-row").forEach(row=>{
    row.children[0].placeholder=t.matName;
    row.children[1].placeholder=t.matQty;
    row.children[2].placeholder=t.matCost;
    row.children[3].placeholder=t.matProfit;
  });
}

function toggleDarkMode(){
  const body=document.body;
  const btn=document.getElementById("themeBtn");
  body.classList.toggle("dark");
  btn.textContent=body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
  localStorage.setItem("theme",body.classList.contains("dark")?"dark":"light");
}

function saveData(){
  const data={
    materials:[],
    workers: document.getElementById("workers").value,
    wage: document.getElementById("wage").value,
    water: document.getElementById("water").value,
    electricity: document.getElementById("electricity").value
  };
  document.querySelectorAll("#materials .input-row").forEach(row=>{
    data.materials.push({
      name: row.children[0].value,
      qty: row.children[1].value,
      cost: row.children[2].value,
      profit: row.children[3].value
    });
  });
  localStorage.setItem("calcData", JSON.stringify(data));
}

function loadData(){
  const data=JSON.parse(localStorage.getItem("calcData"));
  if(!data) return;
  document.getElementById("workers").value=data.workers;
  document.getElementById("wage").value=data.wage;
  document.getElementById("water").value=data.water;
  document.getElementById("electricity").value=data.electricity;
  data.materials.forEach(m=>addMaterial(m.name,m.qty,m.cost,m.profit));
}

function resetAll(){
  localStorage.removeItem("calcData");
  location.reload();
}

// --- Users Online (local only) ---
const userId = Date.now() + Math.random();
sessionStorage.setItem("userId", userId);

function heartbeat() {
  let online = JSON.parse(localStorage.getItem("onlineUsersObj")||"{}");
  online[userId] = Date.now();
  const now = Date.now();
  for(let id in online){ if(now - online[id] > 500) delete online[id]; }
  localStorage.setItem("onlineUsersObj", JSON.stringify(online));
  document.getElementById("userPanel").textContent = `üë• = ${Object.keys(online).length}`;
}
setInterval(heartbeat,100);

// --- PWA Service Worker ---
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js")
    .then(()=>console.log("Service Worker registered"))
    .catch(e=>console.log(e));
}

// --- Load saved data + theme ---
loadData();
if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
  document.getElementById("themeBtn").textContent="‚òÄÔ∏è";
}
</script>
</body>
</html>
